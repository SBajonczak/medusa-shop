import{b as $,u as Y,S as ee,C as se,a as q}from"./chunk-BOR5HF2M-_te45_Ah.js";import{C as D,S as ie}from"./chunk-PYIO3TDQ-D8Zv8hXV.js";import{f as re}from"./chunk-IR5DHEKS-aVJcUHa1.js";import{u as A}from"./chunk-6CNRNROJ-Dwie2T1Q.js";import{C as H}from"./chunk-W6N53UNG-0UnlDtE0.js";import{D as ne}from"./chunk-GE4APTT2-Drx7lH6H.js";import{R as oe,a5 as te,b0 as ae,ar as le,j as e,r as P,b as Z,a8 as ce,o as J,ev as pe,t as G,B as K,ab as de,ac as t,s as W,H as me,T as ue,v as i,I as he,D as ge,g as fe,i as xe,l as _e}from"./index-CXOwuGYo.js";import{b as je}from"./chunk-BF3VCHXD-SnmSoybc.js";import{S as be}from"./chunk-CBJWO6K6-BtmaqyLw.js";import{c as M}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as ye}from"./chunk-6HTZNHPT-3-lwbP-z.js";import{R as O,u as Q,a as Ce,S as Se}from"./chunk-AYRG2MQL-YqvrAt84.js";import{P as v}from"./progress-tabs-V3Y1xpqs.js";import{R as B}from"./radio-group-DrOnxCqY.js";import{S as T}from"./select-CsIRquN0.js";import"./chunk-PDWBYQOW-Dmlh1vBq.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./index.esm-CZJuC6_q.js";import"./x-mark-mini-COfrev7H.js";import"./Trans-MivfKE2Z.js";import"./currency-input-DHe71Akz.js";import"./triangles-mini-8WnZw7zb.js";import"./plus-mini-kqhqcrwq.js";import"./_isIndex-CD5X6UW0.js";import"./index-CXSP-pSV.js";import"./checkbox-B2cxnKzZ.js";import"./prompt-f7mTD0rZ.js";import"./index-seHRa87r.js";import"./check-pD2HlQS4.js";var ve=({form:l,isReturn:m=!1,zone:x,locationId:u,fulfillmentProviderOptions:h,selectedProviderId:_})=>{const{t:o}=Z(),a=A({queryFn:s=>W.admin.shippingProfile.list(s),queryKey:["shipping_profiles"],getOptions:s=>s.shipping_profiles.map(r=>({label:r.name,value:r.id}))}),j=A({queryFn:s=>W.admin.fulfillmentProvider.list({...s,stock_location_id:u}),queryKey:["fulfillment_providers"],getOptions:s=>s.fulfillment_providers.map(r=>({label:re(r.id),value:r.id}))});return e.jsx("div",{className:"flex flex-1 flex-col items-center overflow-y-auto",children:e.jsxs("div",{className:"flex w-full max-w-[720px] flex-col gap-y-8 px-6 py-16",children:[e.jsxs("div",{children:[e.jsx(me,{children:o(`stockLocations.shippingOptions.create.${m?"returns":"shipping"}.header`,{zone:x.name})}),e.jsx(ue,{size:"small",className:"text-ui-fg-subtle",children:o(`stockLocations.shippingOptions.create.${m?"returns":"shipping"}.hint`)})]}),e.jsx(i.Field,{control:l.control,name:"price_type",render:({field:s})=>e.jsxs(i.Item,{children:[e.jsx(i.Label,{children:o("stockLocations.shippingOptions.fields.priceType.label")}),e.jsx(i.Control,{children:e.jsxs(B,{className:"grid grid-cols-1 gap-4 md:grid-cols-2",...s,onValueChange:s.onChange,children:[e.jsx(B.ChoiceBox,{className:"flex-1",value:"flat",label:o("stockLocations.shippingOptions.fields.priceType.options.fixed.label"),description:o("stockLocations.shippingOptions.fields.priceType.options.fixed.hint")}),e.jsx(B.ChoiceBox,{className:"flex-1",value:"calculated",label:o("stockLocations.shippingOptions.fields.priceType.options.calculated.label"),description:o("stockLocations.shippingOptions.fields.priceType.options.calculated.hint")})]})}),e.jsx(i.ErrorMessage,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(i.Field,{control:l.control,name:"name",render:({field:s})=>e.jsxs(i.Item,{children:[e.jsx(i.Label,{children:o("fields.name")}),e.jsx(i.Control,{children:e.jsx(he,{...s})}),e.jsx(i.ErrorMessage,{})]})}),e.jsx(i.Field,{control:l.control,name:"shipping_profile_id",render:({field:s})=>e.jsxs(i.Item,{children:[e.jsx(i.Label,{children:o("stockLocations.shippingOptions.fields.profile")}),e.jsx(i.Control,{children:e.jsx(H,{...s,options:a.options,searchValue:a.searchValue,onSearchValueChange:a.onSearchValueChange,disabled:a.disabled})}),e.jsx(i.ErrorMessage,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(i.Field,{control:l.control,name:"provider_id",render:({field:s})=>e.jsxs(i.Item,{children:[e.jsx(i.Label,{tooltip:o("stockLocations.fulfillmentProviders.shippingOptionsTooltip"),children:o("stockLocations.shippingOptions.fields.provider")}),e.jsx(i.Control,{children:e.jsx(H,{...s,onChange:r=>{s.onChange(r),l.setValue("fulfillment_option_id","")},options:j.options,searchValue:j.searchValue,onSearchValueChange:j.onSearchValueChange,disabled:j.disabled})}),e.jsx(i.ErrorMessage,{})]})}),e.jsx(i.Field,{control:l.control,name:"fulfillment_option_id",render:({field:s})=>e.jsxs(i.Item,{children:[e.jsx(i.Label,{children:o("stockLocations.shippingOptions.fields.fulfillmentOption")}),e.jsx(i.Control,{children:P.createElement(T,{...s,onValueChange:s.onChange,disabled:!_,key:_},e.jsx(T.Trigger,{ref:s.ref,children:e.jsx(T.Value,{})}),e.jsx(T.Content,{children:h==null?void 0:h.filter(r=>!!r.is_return===m).map(r=>e.jsx(T.Item,{value:r.id,children:r.name||r.id},r.id))}))}),e.jsx(i.ErrorMessage,{})]})})]}),e.jsx(ge,{}),e.jsx(be,{control:l.control,name:"enabled_in_store",label:o("stockLocations.shippingOptions.fields.enableInStore.label"),description:o("stockLocations.shippingOptions.fields.enableInStore.hint")})]})})},Oe=({form:l})=>{const{getIsOpen:m,setIsOpen:x}=Ce(),[u,h]=P.useState(null),_=p=>{x(D,!0),h(p)},o=()=>{x(D,!1),h(null)},{store:a,isLoading:j,isError:s,error:r}=fe(),g=P.useMemo(()=>{var p;return((p=a==null?void 0:a.supported_currencies)==null?void 0:p.map(b=>b.currency_code))||[]},[a]),{regions:f,isLoading:S,isError:y,error:k}=xe({fields:"id,name,currency_code",limit:999}),{price_preferences:w}=_e({}),{setCloseOnEscape:z}=Q(),V=J({control:l.control,name:"name"}),F=Y({name:V,currencies:g,regions:f,pricePreferences:w}),I=j||!a||S||!f,n=P.useMemo(()=>[[...g||[],...f||[]]],[g,f]);if(s)throw r;if(y)throw k;return e.jsx(Se,{id:D,onOpenChangeCallback:p=>{p||h(null)},children:e.jsx(ee,{onOpenConditionalPricesModal:_,onCloseConditionalPricesModal:o,children:e.jsxs("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:[e.jsx(ne,{isLoading:I,data:n,columns:F,state:l,onEditingChange:p=>z(!p),disableInteractions:m(D)}),u&&e.jsx(se,{info:u,variant:"create"})]})})})},U=t.object({name:t.string().min(1),price_type:t.nativeEnum(ie),enabled_in_store:t.boolean(),shipping_profile_id:t.string().min(1),provider_id:t.string().min(1),fulfillment_option_id:t.string().min(1)}),Pe=t.object({conditional_region_prices:t.record(t.string(),t.array(q).optional()),conditional_currency_prices:t.record(t.string(),t.array(q).optional())}),we=t.object({region_prices:t.record(t.string(),t.string().optional()),currency_prices:t.record(t.string(),t.string().optional())}).merge(U).merge(Pe);function Le({zone:l,isReturn:m,locationId:x}){var F,I;const[u,h]=P.useState("details"),[_,o]=P.useState(!1),{t:a}=Z(),{handleSuccess:j}=Q(),s=ce({defaultValues:{name:"",price_type:"flat",enabled_in_store:!0,shipping_profile_id:"",provider_id:"",fulfillment_option_id:"",region_prices:{},currency_prices:{},conditional_region_prices:{},conditional_currency_prices:{}},resolver:de(we)}),r=J({control:s.control,name:"provider_id"}),{fulfillment_options:g}=pe(r,{enabled:!!r}),f=s.watch("price_type")==="calculated",{mutateAsync:S,isPending:y}=je(),k=s.handleSubmit(async n=>{const p=Object.entries(n.currency_prices).map(([c,d])=>{if(d)return{currency_code:c,amount:M(d)}}).filter(c=>!!c),b=Object.entries(n.region_prices).map(([c,d])=>{if(d)return{region_id:c,amount:M(d)}}).filter(c=>!!c),L=Object.entries(n.conditional_region_prices).flatMap(([c,d])=>{const C=(d==null?void 0:d.map(N=>({region_id:c,amount:M(N.amount),rules:$(N)})))||[];return C==null?void 0:C.filter(Boolean)}),E=Object.entries(n.conditional_currency_prices).flatMap(([c,d])=>{const C=(d==null?void 0:d.map(N=>({currency_code:c,amount:M(N.amount),rules:$(N)})))||[];return C==null?void 0:C.filter(Boolean)}),R=[...p,...E,...b,...L],X=g==null?void 0:g.find(c=>c.id===n.fulfillment_option_id);await S({name:n.name,price_type:n.price_type,service_zone_id:l.id,shipping_profile_id:n.shipping_profile_id,provider_id:n.provider_id,prices:R,data:X,rules:[{value:m?"true":"false",attribute:"is_return",operator:"eq"},{value:n.enabled_in_store?"true":"false",attribute:"enabled_in_store",operator:"eq"}],type:{label:"Type label",description:"Type description",code:"type-code"}},{onSuccess:({shipping_option:c})=>{G.success(a(`stockLocations.shippingOptions.create.${m?"returns":"shipping"}.successToast`,{name:c.name})),j(`/settings/locations/${x}`)},onError:c=>{G.error(c.message)}})}),w=n=>{if(n==="pricing"){s.clearErrors();const p=U.safeParse({...s.getValues()});if(!p.success){const[b,...L]=p.error.errors;for(const E of L){const R=E.path.join(".");s.setError(R,{message:E.message,type:E.code})}s.setError(b.path.join("."),{message:b.message,type:b.code},{shouldFocus:!0}),o(!1);return}o(!0)}h(n)},z=(F=s.getFieldState("currency_prices"))!=null&&F.isDirty||(I=s.getFieldState("region_prices"))!=null&&I.isDirty||u==="pricing"?"in-progress":"not-started",V=_?"completed":"in-progress";return e.jsx(O.Form,{form:s,children:e.jsx(ye,{className:"flex h-full flex-col",onSubmit:k,onKeyDown:n=>{const p=n.key==="Enter",b=n.metaKey||n.ctrlKey,L=u!=="pricing"&&!f;if(p&&(n.preventDefault(),!!b)){if(L){n.stopPropagation(),w("pricing");return}k()}},children:e.jsxs(v,{value:u,className:"flex h-full flex-col overflow-hidden",onValueChange:n=>w(n),children:[e.jsx(O.Header,{children:e.jsxs(v.List,{className:"border-ui-border-base -my-2 ml-2 min-w-0 flex-1 border-l",children:[e.jsx(v.Trigger,{value:"details",status:V,className:"w-full max-w-[200px]",children:e.jsx("span",{className:"w-full cursor-auto overflow-hidden text-ellipsis whitespace-nowrap",children:a("stockLocations.shippingOptions.create.tabs.details")})}),!f&&e.jsx(v.Trigger,{value:"pricing",status:z,className:"w-full max-w-[200px]",children:e.jsx("span",{className:"w-full overflow-hidden text-ellipsis whitespace-nowrap",children:a("stockLocations.shippingOptions.create.tabs.prices")})})]})}),e.jsxs(O.Body,{className:"size-full overflow-hidden",children:[e.jsx(v.Content,{value:"details",className:"size-full overflow-y-auto",children:e.jsx(ve,{form:s,zone:l,isReturn:m,locationId:x,fulfillmentProviderOptions:g||[],selectedProviderId:r})}),e.jsx(v.Content,{value:"pricing",className:"size-full",children:e.jsx(Oe,{form:s})})]}),e.jsx(O.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(O.Close,{asChild:!0,children:e.jsx(K,{variant:"secondary",size:"small",children:a("actions.cancel")})}),u==="pricing"||f?e.jsx(K,{size:"small",className:"whitespace-nowrap",isLoading:y,type:"submit",children:a("actions.save")},"submit-btn"):e.jsx(K,{size:"small",className:"whitespace-nowrap",isLoading:y,onClick:()=>w("pricing"),type:"button",children:a("actions.continue")},"continue-btn")]})})]})})})}var Ee="*fulfillment_sets,*fulfillment_sets.service_zones,*fulfillment_sets.service_zones.shipping_options";function os(){var g,f,S;const{location_id:l,fset_id:m,zone_id:x}=oe(),[u]=te(),h=u.has("is_return"),{stock_location:_,isPending:o,isFetching:a,isError:j,error:s}=ae(l,{fields:Ee}),r=(S=(f=(g=_==null?void 0:_.fulfillment_sets)==null?void 0:g.find(y=>y.id===m))==null?void 0:f.service_zones)==null?void 0:S.find(y=>y.id===x);if(!o&&!a&&!r)throw le({message:`Service zone with ID ${x} was not found`},404);if(j)throw s;return e.jsx(O,{prev:`/settings/locations/${l}`,children:r&&e.jsx(Le,{zone:r,isReturn:h,locationId:l})})}export{os as Component};
